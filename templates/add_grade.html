<!-- templates/add_grade.html -->
{% extends "base.html" %}

{% block title %}添加成绩 - {{ student.name }} - {{ super() }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- 页面标题和导航 -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="h4 mb-0">
                        <i class="fas fa-plus-circle text-success me-2"></i>添加成绩
                    </h2>
                    <p class="text-muted small mb-0">
                        为学生 <strong>{{ student.name }}</strong> ({{ student.student_id }}) 添加课程成绩
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('main.student_detail', student_id=student.id) }}" 
                       class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left me-1"></i>返回学生详情
                    </a>
                </div>
            </div>

            <!-- 学生信息摘要 -->
            <div class="card border-info mb-4">
                <div class="card-body py-3">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                         style="width: 50px; height: 50px;">
                                        <i class="fas fa-user-graduate"></i>
                                    </div>
                                </div>
                                <div>
                                    <h6 class="mb-1">{{ student.name }}</h6>
                                    <div class="text-muted small">
                                        <span class="me-3">
                                            <i class="fas fa-id-card me-1"></i>{{ student.student_id }}
                                        </span>
                                        {% if student.class_name %}
                                        <span>
                                            <i class="fas fa-users me-1"></i>{{ student.class_name }}
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <div class="text-muted small">
                                当前已有成绩：<strong>{{ student.grades|length }}</strong> 门课程
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 添加成绩表单 -->
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-edit me-2"></i>成绩信息填写
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="" novalidate>
                        {{ form.hidden_tag() }}
                        
                        <!-- 学生信息（固定显示） -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">学生信息</label>
                            <div class="alert alert-info py-2 mb-0">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-user-check text-info me-3 fs-5"></i>
                                    <div>
                                        <div class="fw-bold">{{ student.name }}</div>
                                        <small class="text-muted">
                                            学号：{{ student.student_id }} | 
                                            班级：{{ student.class_name or '未设置' }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" name="student_id" value="{{ student.id }}">
                        </div>

                        <!-- 课程选择 -->
                        <div class="mb-4">
                            <label class="form-label">
                                {{ form.course_id.label.text }} <span class="text-danger">*</span>
                            </label>
                            {{ form.course_id(class="form-select form-select-lg") }}
                            {% if form.course_id.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.course_id.errors %}
                                <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text">
                                选择要添加成绩的课程。如果课程已存在成绩，系统会提示。
                            </div>
                        </div>

                        <!-- 成绩输入 -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label">
                                    {{ form.score.label.text }} <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    {{ form.score(class="form-control form-control-lg", 
                                                placeholder="0-100分", 
                                                min="0", max="100", step="0.1") }}
                                    <span class="input-group-text">分</span>
                                </div>
                                {% if form.score.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.score.errors %}
                                    <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">成绩等级</label>
                                <div class="border rounded p-3 text-center">
                                    <span class="fw-bold fs-4" id="gradeLevelDisplay">-</span>
                                    <div class="text-muted small mt-1">根据分数自动计算</div>
                                </div>
                            </div>
                        </div>

                        <!-- 绩点显示 -->
                        <div class="mb-4">
                            <label class="form-label">绩点</label>
                            <div class="alert alert-light border">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-star text-warning me-3 fs-4"></i>
                                            <div>
                                                <div class="fw-bold fs-3" id="gradePointDisplay">0.0</div>
                                                <small class="text-muted">4.0制绩点</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="text-muted small">
                                            绩点计算规则：
                                            <ul class="mb-0 mt-1">
                                                <li>90-100分：4.0 绩点</li>
                                                <li>80-89分：3.0 绩点</li>
                                                <li>70-79分：2.0 绩点</li>
                                                <li>60-69分：1.0 绩点</li>
                                                <li>60分以下：0.0 绩点</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 考试日期和备注 -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label">{{ form.exam_date.label.text }}</label>
                                {{ form.exam_date(class="form-control", type="date") }}
                                {% if form.exam_date.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.exam_date.errors %}
                                    <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">成绩状态</label>
                                <div class="border rounded p-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="makeupExam">
                                        <label class="form-check-label" for="makeupExam">
                                            补考成绩
                                        </label>
                                    </div>
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="checkbox" id="retakeCourse">
                                        <label class="form-check-label" for="retakeCourse">
                                            重修成绩
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 备注 -->
                        <div class="mb-4">
                            <label class="form-label">{{ form.note.label.text }}</label>
                            {{ form.note(class="form-control", rows="3", 
                                       placeholder="可填写考试情况、特殊说明等信息（选填）") }}
                            {% if form.note.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.note.errors %}
                                <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text">最多500个字符</div>
                        </div>

                        <!-- 表单操作按钮 -->
                        <div class="d-flex justify-content-between align-items-center pt-4 border-top">
                            <div>
                                <a href="{{ url_for('main.student_detail', student_id=student.id) }}" 
                                   class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i>取消
                                </a>
                            </div>
                            <div>
                                <button type="reset" class="btn btn-outline-warning me-2">
                                    <i class="fas fa-redo me-1"></i>重置
                                </button>
                                {{ form.submit(class="btn btn-success btn-lg") }}
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 填写提示 -->
            <div class="card mt-4 border-primary">
                <div class="card-body py-3">
                    <h6 class="card-title text-primary mb-2">
                        <i class="fas fa-lightbulb me-2"></i>填写提示
                    </h6>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <strong>分数范围：</strong>0-100分，可输入小数（如85.5）
                        </div>
                        <div class="col-md-6 mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <strong>考试日期：</strong>如不填写，默认使用提交日期
                        </div>
                        <div class="col-md-6 mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <strong>课程选择：</strong>系统会检查是否已存在该课程成绩
                        </div>
                        <div class="col-md-6 mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <strong>成绩等级：</strong>根据分数自动计算并显示
                        </div>
                    </div>
                </div>
            </div>

            <!-- 该学生已有成绩预览 -->
            {% if student.grades %}
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-history me-2"></i>已有成绩预览
                        <small class="text-muted">(共 {{ student.grades|length }} 门课程)</small>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>课程</th>
                                    <th class="text-center">成绩</th>
                                    <th class="text-center">等级</th>
                                    <th>考试日期</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for grade in student.grades[:5] %}
                                <tr>
                                    <td>
                                        <small>{{ grade.course.course_name }}</small>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge 
                                            {% if grade.score >= 90 %}bg-success
                                            {% elif grade.score >= 80 %}bg-primary
                                            {% elif grade.score >= 70 %}bg-info
                                            {% elif grade.score >= 60 %}bg-warning
                                            {% else %}bg-danger{% endif %}">
                                            {{ grade.score }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <small>{{ grade.grade_level }}</small>
                                    </td>
                                    <td>
                                        <small>
                                            {% if grade.exam_date %}
                                                {{ grade.exam_date.strftime('%Y-%m-%d') }}
                                            {% else %}
                                                <span class="text-muted">未设置</span>
                                            {% endif %}
                                        </small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if student.grades|length > 5 %}
                    <div class="text-center mt-2">
                        <small class="text-muted">
                            还有 {{ student.grades|length - 5 }} 门课程成绩未显示...
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 根据分数计算等级和绩点
function calculateGradeLevel(score) {
    if (score >= 90) return { level: 'A (优秀)', point: 4.0, color: 'text-success' };
    if (score >= 80) return { level: 'B (良好)', point: 3.0, color: 'text-primary' };
    if (score >= 70) return { level: 'C (中等)', point: 2.0, color: 'text-info' };
    if (score >= 60) return { level: 'D (及格)', point: 1.0, color: 'text-warning' };
    return { level: 'F (不及格)', point: 0.0, color: 'text-danger' };
}

// 更新等级和绩点显示
function updateGradeDisplay() {
    const scoreInput = document.getElementById('{{ form.score.id }}');
    const gradeLevelDisplay = document.getElementById('gradeLevelDisplay');
    const gradePointDisplay = document.getElementById('gradePointDisplay');
    
    if (scoreInput.value.trim() !== '') {
        const score = parseFloat(scoreInput.value);
        if (!isNaN(score) && score >= 0 && score <= 100) {
            const result = calculateGradeLevel(score);
            gradeLevelDisplay.textContent = result.level;
            gradeLevelDisplay.className = `fw-bold fs-4 ${result.color}`;
            gradePointDisplay.textContent = result.point.toFixed(1);
            gradePointDisplay.className = `fw-bold fs-3 ${result.color}`;
            return;
        }
    }
    
    // 默认显示
    gradeLevelDisplay.textContent = '-';
    gradeLevelDisplay.className = 'fw-bold fs-4 text-muted';
    gradePointDisplay.textContent = '0.0';
    gradePointDisplay.className = 'fw-bold fs-3 text-muted';
}

// 页面初始化
document.addEventListener('DOMContentLoaded', function() {
    // 绑定分数输入事件
    const scoreInput = document.getElementById('{{ form.score.id }}');
    if (scoreInput) {
        scoreInput.addEventListener('input', updateGradeDisplay);
        scoreInput.addEventListener('change', updateGradeDisplay);
    }
    
    // 设置默认考试日期为今天
    const examDateInput = document.getElementById('{{ form.exam_date.id }}');
    if (examDateInput && !examDateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        examDateInput.value = today;
    }
    
    // 课程选择时检查是否已有成绩
    const courseSelect = document.getElementById('{{ form.course_id.id }}');
    if (courseSelect) {
        courseSelect.addEventListener('change', function() {
            // 这里可以添加AJAX检查逻辑
            console.log('选择了课程ID:', this.value);
        });
    }
    
    // 表单验证增强
    const form = document.querySelector('form');
    form.addEventListener('submit', function(event) {
        let isValid = true;
        const requiredFields = form.querySelectorAll('[required]');
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                isValid = false;
                field.classList.add('is-invalid');
                
                // 滚动到第一个错误字段
                if (isValid === false) {
                    field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        // 检查分数范围
        const scoreField = document.getElementById('{{ form.score.id }}');
        if (scoreField && scoreField.value.trim()) {
            const score = parseFloat(scoreField.value);
            if (isNaN(score) || score < 0 || score > 100) {
                isValid = false;
                scoreField.classList.add('is-invalid');
                alert('请输入0-100之间的有效分数！');
            }
        }
        
        if (!isValid) {
            event.preventDefault();
            alert('请正确填写所有必填字段（标有 * 的字段）');
        }
    });
    
    // 初始化显示
    updateGradeDisplay();
});

// 键盘快捷键支持
document.addEventListener('keydown', function(event) {
    // Ctrl + Enter 提交表单
    if (event.ctrlKey && event.key === 'Enter') {
        const submitBtn = document.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.click();
        }
    }
    
    // Esc 键返回学生详情
    if (event.key === 'Escape') {
        const backBtn = document.querySelector('a[href*="student_detail"]');
        if (backBtn) {
            backBtn.click();
        }
    }
});
</script>

<style>
/* 自定义样式 */
.form-control-lg {
    font-size: 1.1rem;
    padding: 0.75rem 1rem;
}

.input-group-text {
    background-color: #f8f9fa;
}

.alert-light.border {
    border-color: #dee2e6 !important;
}

/* 分数输入框聚焦样式 */
#{{ form.score.id }}:focus {
    border-color: #198754;
    box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25);
}

/* 课程选择框样式 */
#{{ form.course_id.id }} option {
    padding: 10px;
}

/* 响应式调整 */
@media (max-width: 768px) {
    .card-body {
        padding: 1rem;
    }
    
    .btn-lg {
        padding: 0.5rem 1rem;
        font-size: 1rem;
    }
}
</style>
{% endblock %}